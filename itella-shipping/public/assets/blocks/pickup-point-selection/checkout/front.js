(()=>{"use strict";const e=window.wc.blocksCheckout,t=window.React,i=window.wp.element,s=window.wp.data,l=window.wp.components,o=window.wp.i18n,n={id:"itella-shipping",pickup_methods_keys:["pickup_point"]},a=()=>wcSettings&&wcSettings["itella-shipping-blocks_data"]?wcSettings["itella-shipping-blocks_data"]:{},r=(e,t=!1)=>{let i=a();if("methods"in i)for(let s in i.methods)if(i.methods[s]==e&&(!t||t&&n.pickup_methods_keys.includes(s)))return!0;return!1},p=e=>{const t=((e=!0)=>{let t={block_options:(0,o.__)("Block options","itella-shipping"),pickup_block_title:(0,o.__)("Parcel locker","itella-shipping"),pickup_select_field_default:(0,o.__)("Select a parcel locker","itella-shipping"),cart_pickup_info:(0,o.__)("You can choose the parcel locker on the Checkout page","itella-shipping"),checkout_pickup_info:(0,o.__)("Choose one of parcel lockers close to the address you entered","itella-shipping"),pickup_error:(0,o.__)("Please choose a parcel locker","itella-shipping"),mapping:{nothing_found:(0,o.__)("Nothing found","itella-shipping"),modal_header:(0,o.__)("Parcel lockers","itella-shipping"),selector_header:(0,o.__)("Parcel locker","itella-shipping"),workhours_header:(0,o.__)("Workhours","itella-shipping"),contacts_header:(0,o.__)("Contacts","itella-shipping"),search_placeholder:(0,o.__)("Enter postcode/address","itella-shipping"),select_pickup_point:(0,o.__)("Select a parcel locker","itella-shipping"),no_pickup_points:(0,o.__)("No locker to select","itella-shipping"),select_btn:(0,o.__)("select","itella-shipping"),back_to_list_btn:(0,o.__)("reset search","itella-shipping"),select_pickup_point_btn:(0,o.__)("Select parcel locker","itella-shipping"),no_information:(0,o.__)("No information","itella-shipping"),error_leaflet:(0,o.__)("Leaflet is required for Itella-Mapping","itella-shipping"),error_missing_mount_el:(0,o.__)("No mount supplied to itellaShipping","itella-shipping")}};if(!e){const e=a();return"txt"in e?e.txt:{}}return t})(!1),i=Array.isArray(e)?e:[e];let s=t;for(const e of i){if(!s||"object"!=typeof s||!(e in s))return i[i.length-1];s=s[e]}return s},c=()=>({lib:null,elements:{},params:{},text:{},load_data:function(e){return this.elements={org_field:this.set_param(e,"org_field",null),container:this.set_param(e,"container",null)},this.params={images_url:this.set_param(e,"images_url","/"),selection_style:this.set_param(e,"selection_style","map"),country:this.set_param(e,"country",""),postcode:this.set_param(e,"postcode","")},this.text={nothing_found:p(["mapping","nothing_found"]),modal_header:p(["mapping","modal_header"]),selector_header:p(["mapping","selector_header"]),workhours_header:p(["mapping","workhours_header"]),contacts_header:p(["mapping","contacts_header"]),search_placeholder:p(["mapping","search_placeholder"]),select_pickup_point:p(["mapping","select_pickup_point"]),no_pickup_points:p(["mapping","no_pickup_points"]),select_btn:p(["mapping","select_btn"]),back_to_list_btn:p(["mapping","back_to_list_btn"]),select_pickup_point_btn:p(["mapping","select_pickup_point_btn"]),no_information:p(["mapping","no_information"]),error_leaflet:p(["mapping","error_leaflet"]),error_missing_mount_el:p(["mapping","error_missing_mount_el"])},this},set_param:function(e,t,i=null){return t in e?e[t]:i},init:function(e){this.lib=new itellaMapping(this.elements.container),this.lib.setImagesUrl(this.params.images_url),this.lib.setStrings(this.text),this.lib.init("map"==this.params.selection_style),this.lib.setCountry(this.params.country),this.lib.setLocations(e,!0),this.lib.registerCallback(function(e){localStorage.setItem("itellaPickupPoint",JSON.stringify({id:this.lib.selectedPoint.id})),this.update_org_field_value(this.lib.selectedPoint.id)}.bind(this)),this.elements.org_field.parentElement.style.display="none",this.sort_dropdown_by_postcode()},update_org_field_value:function(e){if(!this.elements.org_field)return;const t=new Event("change",{bubbles:!0});this.elements.org_field.value=e,this.elements.org_field.dispatchEvent(t)},sort_dropdown_by_postcode:function(){this.lib.UI[this.lib.isModal?"modal":"container"].getElementsByClassName("search-input")[0].value=this.params.postcode,this.lib.searchNearest(""+this.params.postcode)}}),_=JSON.parse('{"apiVersion":2,"name":"itella-shipping/pickup-point-selection-checkout","version":"1.0.0","title":"Smartpost parcel locker selection","category":"woocommerce","description":"Allow to add components for Smartpost shipping method on Checkout page","parent":["woocommerce/checkout-shipping-methods-block"],"supports":{"html":false,"align":false,"multiple":false,"reusable":false},"attributes":{"lock":{"type":"object","default":{"remove":true,"move":true}},"text":{"type":"string","default":""}},"textdomain":"itella-shipping"}');(0,e.registerCheckoutBlock)({metadata:_,component:({checkoutExtensionData:e,extension:o})=>{const _="itella_pickup_point",{setExtensionData:u}=e,[d,h]=(0,i.useState)([]),[g,m]=(0,i.useState)({country:"",address:"",city:"",postcode:""}),[f,k]=(0,i.useState)(""),[b,y]=(0,i.useState)([]),[w,E]=(0,i.useState)({}),[S,v]=(0,i.useState)(!1),[C,N]=(0,i.useState)(""),O=(0,i.useRef)(null),x=(0,i.useRef)(null),A=c(),{setValidationErrors:P,clearValidationError:j}=(0,s.useDispatch)("wc/store/validation"),D=(0,s.useSelect)((e=>e("wc/store/validation").getValidationError(_))),{shippingRates:R,shippingAddress:J}=(0,s.useSelect)((e=>{const t=e("wc/store/cart");return{shippingRates:t.getCartData().shippingRates,shippingAddress:t.getCartData().shippingAddress}})),$=(e=>{const[t,s]=(0,i.useState)(e);return(0,i.useEffect)((()=>{const t=setTimeout((()=>{s(e)}),1500);return()=>{clearTimeout(t)}}),[e,1500]),t})(J);return(0,i.useEffect)((()=>{R.length&&h((e=>{if(!e.length)return[];let t=[];for(let i=0;i<e.length;i++)if(e[i].shipping_rates)for(let s=0;s<e[i].shipping_rates.length;s++)e[i].shipping_rates[s].rate_id&&t.push(e[i].shipping_rates[s]);return t})(R))}),[R]),(0,i.useEffect)((()=>{if(J.country){let i={country:J.country,address:J?.address_1||"",city:J?.city||"",postcode:J?.postcode||""};e=g,t=i,JSON.stringify(e)!==JSON.stringify(t)&&m(i)}var e,t}),[$]),(0,i.useEffect)((()=>{if(d.length)for(let e=0;e<d.length;e++)d[e].selected&&f!=d[e].rate_id&&k(d[e].rate_id)}),[d]),(0,i.useEffect)((()=>{""!=f.trim()&&(r(f,!0)?v(!0):v(!1))}),[f]),(0,i.useEffect)((()=>{S&&""!==g.country&&(async e=>{try{const t=a(),i=await fetch(`${t.locations_url}locations${e}.json`,{method:"HEAD"});if(!i.ok)throw new Error(`File not found: ${i.status}`);const s=await fetch(`${t.locations_url}locations${e}.json`);if(!s.ok)throw new Error(`Error: ${s.status}`);return await s.json()}catch(e){console.error("Failed to get locations.",e)}return null})(g.country).then((e=>{y((e=>{let t=a(),i=Array.isArray(e)?JSON.parse(JSON.stringify(e)):[];if(!t.hasOwnProperty("locations_filter"))return i;let s=i.length;for(;s--;)if(Object.hasOwn(i[s],"capabilities"))for(let e=0;e<i[s].capabilities.length;e++)"yes"==t.locations_filter.exclude_outdoors&&"outdoors"==i[s].capabilities[e].name&&"OUTDOORS"==i[s].capabilities[e].value&&i.splice(s,1);return i})(e))}))}),[S,g]),(0,i.useEffect)((()=>{let e=((e,t)=>{let i=[];if(e.length)for(let t=0;t<e.length;t++)i.push({id:(s=e[t]).id,pupCode:s?.pupCode||"",publicName:s?.publicName||"-",address:s?.address?.address||"",city:s?.address?.municipality||"",postcode:s?.address?.postalCode||""});var s;return i.sort(((e,i)=>e.city.localeCompare(i.city,t.toLowerCase(),{sensitivity:"base"}))).reduce(((e,t)=>{let i=t.city.trim();return e[i]||(e[i]=[]),e[i].push(t),e}),{})})(b,g.country),t={};t["-"]=[{label:p("pickup_select_field_default"),value:""}];for(let i in e){t[i]||(t[i]=[]);for(let s=0;s<e[i].length;s++)t[i].push({label:e[i][s].publicName+", "+e[i][s].address+", "+e[i][s].city,value:e[i][s].id})}E(t)}),[b]),(0,i.useEffect)((()=>{if(!Object.values(w).length||!x.current)return;x.current.innerHTML="";let e=a();A.load_data({org_field:O.current,container:x.current,selection_style:e.selection_style,images_url:e.images_url,country:g.country,postcode:g.postcode}).init(b)}),[w]),(0,i.useEffect)((()=>{_&&j(_),""!=f.trim()&&r(f)&&(u(n.id,"selected_rate_id",f),r(f,!0)&&(u(n.id,"selected_pickup_id",C),""===C&&P({[_]:{message:p("pickup_error"),hidden:!1}})))}),[u,f,C]),S?(0,t.createElement)("div",{className:"itella-shipping-block"},(0,t.createElement)(l.SelectControl,{id:"itella-pickup-points-list",label:p("pickup_block_title"),value:C,onChange:e=>N(e),ref:O},Object.keys(w).map((e=>"-"===e?(0,t.createElement)("option",{key:"default",value:""},w[e][0].label):(0,t.createElement)("optgroup",{key:e,label:e},w[e].map((e=>(0,t.createElement)("option",{key:e.value,value:e.value},e.label))))))),(0,t.createElement)("div",{id:"itella-pickup-points-selection",ref:x}),D?.hidden||""!==C?null:(0,t.createElement)("div",{className:"wc-block-components-validation-error"},(0,t.createElement)("span",null,D?.message))):(0,t.createElement)(t.Fragment,null)}})})();